@page
@model ClassesModel
@{
    ViewData["Title"] = "职业管理";
    ViewData["ActivePage"] = "Classes";
}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="mb-0">职业管理</h4>
        <small class="text-muted">职业统计、创建设置、角色职业修改</small>
    </div>
</div>

<!-- 职业统计 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <i class="bi bi-shield-fill display-4 text-danger"></i>
                <h5 class="mt-2">战士</h5>
                <div class="d-flex justify-content-around">
                    <div>
                        <span class="fs-3 fw-bold text-danger">@Model.WarriorCount</span>
                        <br><small class="text-muted">总数</small>
                    </div>
                    <div>
                        <span class="fs-4 fw-bold text-success">@Model.OnlineWarriorCount</span>
                        <br><small class="text-muted">在线</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="bi bi-lightning-fill display-4 text-primary"></i>
                <h5 class="mt-2">法师</h5>
                <div class="d-flex justify-content-around">
                    <div>
                        <span class="fs-3 fw-bold text-primary">@Model.WizardCount</span>
                        <br><small class="text-muted">总数</small>
                    </div>
                    <div>
                        <span class="fs-4 fw-bold text-success">@Model.OnlineWizardCount</span>
                        <br><small class="text-muted">在线</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="bi bi-heart-pulse-fill display-4 text-success"></i>
                <h5 class="mt-2">道士</h5>
                <div class="d-flex justify-content-around">
                    <div>
                        <span class="fs-3 fw-bold text-success">@Model.TaoistCount</span>
                        <br><small class="text-muted">总数</small>
                    </div>
                    <div>
                        <span class="fs-4 fw-bold text-success">@Model.OnlineTaoistCount</span>
                        <br><small class="text-muted">在线</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-dark">
            <div class="card-body">
                <i class="bi bi-moon-stars-fill display-4 text-dark"></i>
                <h5 class="mt-2">刺客</h5>
                <div class="d-flex justify-content-around">
                    <div>
                        <span class="fs-3 fw-bold text-dark">@Model.AssassinCount</span>
                        <br><small class="text-muted">总数</small>
                    </div>
                    <div>
                        <span class="fs-4 fw-bold text-success">@Model.OnlineAssassinCount</span>
                        <br><small class="text-muted">在线</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 职业创建设置 -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <i class="bi bi-toggles"></i> 职业创建设置 <span class="badge bg-danger">需要 SuperAdmin 权限</span>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <form method="post" asp-page-handler="ToggleClass">
                    <input type="hidden" name="className" value="Warrior">
                    <input type="hidden" name="allow" value="@(!Model.AllowWarrior ? "true" : "false")">
                    <button type="submit" class="btn @(Model.AllowWarrior ? "btn-danger" : "btn-outline-danger") w-100">
                        <i class="bi @(Model.AllowWarrior ? "bi-check-circle" : "bi-x-circle")"></i>
                        战士: @(Model.AllowWarrior ? "允许创建" : "禁止创建")
                    </button>
                </form>
            </div>
            <div class="col-md-3">
                <form method="post" asp-page-handler="ToggleClass">
                    <input type="hidden" name="className" value="Wizard">
                    <input type="hidden" name="allow" value="@(!Model.AllowWizard ? "true" : "false")">
                    <button type="submit" class="btn @(Model.AllowWizard ? "btn-primary" : "btn-outline-primary") w-100">
                        <i class="bi @(Model.AllowWizard ? "bi-check-circle" : "bi-x-circle")"></i>
                        法师: @(Model.AllowWizard ? "允许创建" : "禁止创建")
                    </button>
                </form>
            </div>
            <div class="col-md-3">
                <form method="post" asp-page-handler="ToggleClass">
                    <input type="hidden" name="className" value="Taoist">
                    <input type="hidden" name="allow" value="@(!Model.AllowTaoist ? "true" : "false")">
                    <button type="submit" class="btn @(Model.AllowTaoist ? "btn-success" : "btn-outline-success") w-100">
                        <i class="bi @(Model.AllowTaoist ? "bi-check-circle" : "bi-x-circle")"></i>
                        道士: @(Model.AllowTaoist ? "允许创建" : "禁止创建")
                    </button>
                </form>
            </div>
            <div class="col-md-3">
                <form method="post" asp-page-handler="ToggleClass">
                    <input type="hidden" name="className" value="Assassin">
                    <input type="hidden" name="allow" value="@(!Model.AllowAssassin ? "true" : "false")">
                    <button type="submit" class="btn @(Model.AllowAssassin ? "btn-dark" : "btn-outline-dark") w-100">
                        <i class="bi @(Model.AllowAssassin ? "bi-check-circle" : "bi-x-circle")"></i>
                        刺客: @(Model.AllowAssassin ? "允许创建" : "禁止创建")
                    </button>
                </form>
            </div>
        </div>
        <small class="text-muted mt-2 d-block">控制玩家是否可以创建对应职业的角色</small>
    </div>
</div>

<!-- 在线玩家转职 -->
<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <i class="bi bi-arrow-repeat"></i> 在线玩家转职 <span class="badge bg-warning text-dark">需要 SuperAdmin 权限</span>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="ChangeClass" onsubmit="return confirm('确定要修改该玩家的职业吗？这将清空玩家的所有技能！')">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">在线玩家名称</label>
                    <input type="text" class="form-control" name="playerName" placeholder="角色名称" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">新职业</label>
                    <select class="form-select" name="newClass" required>
                        <option value="">选择职业</option>
                        <option value="Warrior">战士</option>
                        <option value="Wizard">法师</option>
                        <option value="Taoist">道士</option>
                        <option value="Assassin">刺客</option>
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-arrow-repeat"></i> 转职
                    </button>
                </div>
            </div>
        </form>
        <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle"></i> <strong>注意：</strong>转职会清空玩家的所有技能，玩家需要重新登录后生效。
        </div>
    </div>
</div>

<!-- 角色列表 -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-search"></i> 角色列表
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label">职业筛选</label>
                <select class="form-select" name="ClassFilter">
                    <option value="">全部职业</option>
                    <option value="Warrior" selected="@(Model.ClassFilter == "Warrior")">战士</option>
                    <option value="Wizard" selected="@(Model.ClassFilter == "Wizard")">法师</option>
                    <option value="Taoist" selected="@(Model.ClassFilter == "Taoist")">道士</option>
                    <option value="Assassin" selected="@(Model.ClassFilter == "Assassin")">刺客</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">搜索</label>
                <input type="text" class="form-control" name="Keyword" value="@Model.Keyword" placeholder="角色名/账户">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> 搜索
                </button>
                <a href="/Classes" class="btn btn-secondary">
                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                </a>
            </div>
            <div class="col-md-2 d-flex align-items-end justify-content-end">
                <span class="badge bg-secondary fs-6">共 @Model.CharacterTotalCount 个角色</span>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>角色名</th>
                        <th>职业</th>
                        <th>性别</th>
                        <th>等级</th>
                        <th>账户</th>
                        <th>最后登录</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Characters.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">
                                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                没有找到角色数据
                            </td>
                        </tr>
                    }
                    @foreach (var character in Model.Characters)
                    {
                        <tr>
                            <td><code>@character.Index</code></td>
                            <td><strong>@character.Name</strong></td>
                            <td>
                                @switch (character.Class)
                                {
                                    case "Warrior":
                                        <span class="badge bg-danger">战士</span>
                                        break;
                                    case "Wizard":
                                        <span class="badge bg-primary">法师</span>
                                        break;
                                    case "Taoist":
                                        <span class="badge bg-success">道士</span>
                                        break;
                                    case "Assassin":
                                        <span class="badge bg-dark">刺客</span>
                                        break;
                                    default:
                                        <span class="badge bg-secondary">@character.Class</span>
                                        break;
                                }
                            </td>
                            <td>
                                @if (character.Gender == "Male")
                                {
                                    <i class="bi bi-gender-male text-primary"></i>
                                }
                                else
                                {
                                    <i class="bi bi-gender-female text-danger"></i>
                                }
                            </td>
                            <td><span class="badge bg-info">Lv.@character.Level</span></td>
                            <td><small class="text-muted">@character.AccountEmail</small></td>
                            <td><small>@character.LastLogin.ToString("yyyy-MM-dd HH:mm")</small></td>
                            <td>
                                @if (character.IsOnline)
                                {
                                    <span class="badge bg-success"><i class="bi bi-circle-fill"></i> 在线</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">离线</span>
                                }
                            </td>
                            <td>
                                @if (!character.IsOnline)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-warning"
                                            data-bs-toggle="modal"
                                            data-bs-target="#changeClassModal"
                                            data-index="@character.Index"
                                            data-name="@character.Name"
                                            data-class="@character.Class">
                                        <i class="bi bi-arrow-repeat"></i> 转职
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted">在线中</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (Model.TotalPages > 1)
        {
            <nav class="mt-3">
                <ul class="pagination pagination-sm mb-0 justify-content-center">
                    @if (Model.CurrentPage > 1)
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Classes?CurrentPage=@(Model.CurrentPage - 1)&ClassFilter=@Model.ClassFilter&Keyword=@Model.Keyword">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    }
                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                    {
                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                            <a class="page-link" href="/Classes?CurrentPage=@i&ClassFilter=@Model.ClassFilter&Keyword=@Model.Keyword">@i</a>
                        </li>
                    }
                    @if (Model.CurrentPage < Model.TotalPages)
                    {
                        <li class="page-item">
                            <a class="page-link" href="/Classes?CurrentPage=@(Model.CurrentPage + 1)&ClassFilter=@Model.ClassFilter&Keyword=@Model.Keyword">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    }
                </ul>
            </nav>
        }
    </div>
</div>

<!-- 职业基础属性 -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <i class="bi bi-bar-chart"></i> 职业基础属性 <span class="badge bg-warning text-dark">需要 SuperAdmin 权限编辑</span>
    </div>
    <div class="card-body">
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <form method="get">
                    <input type="hidden" name="ClassFilter" value="@Model.ClassFilter">
                    <input type="hidden" name="Keyword" value="@Model.Keyword">
                    <input type="hidden" name="CurrentPage" value="@Model.CurrentPage">
                    <label class="form-label">筛选职业</label>
                    <select class="form-select" name="StatClassFilter" onchange="this.form.submit()">
                        <option value="">全部职业</option>
                        <option value="Warrior" selected="@(Model.StatClassFilter == "Warrior")">战士</option>
                        <option value="Wizard" selected="@(Model.StatClassFilter == "Wizard")">法师</option>
                        <option value="Taoist" selected="@(Model.StatClassFilter == "Taoist")">道士</option>
                        <option value="Assassin" selected="@(Model.StatClassFilter == "Assassin")">刺客</option>
                    </select>
                </form>
            </div>
            <div class="col-md-6">
                <form method="post" asp-page-handler="CreateBaseStat" class="row g-2">
                    <div class="col-md-5">
                        <label class="form-label">新增属性</label>
                        <select class="form-select" name="statClass" required>
                            <option value="">选择职业</option>
                            <option value="Warrior">战士</option>
                            <option value="Wizard">法师</option>
                            <option value="Taoist">道士</option>
                            <option value="Assassin">刺客</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">等级</label>
                        <input type="number" class="form-control" name="level" min="1" max="255" placeholder="等级" required>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> 新增
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-sm table-hover table-striped mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>职业</th>
                        <th>等级</th>
                        <th>生命</th>
                        <th>魔法</th>
                        <th>负重</th>
                        <th>穿戴</th>
                        <th>腕力</th>
                        <th>准确</th>
                        <th>敏捷</th>
                        <th>AC</th>
                        <th>MR</th>
                        <th>DC</th>
                        <th>MC</th>
                        <th>SC</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.BaseStats.Count == 0)
                    {
                        <tr>
                            <td colspan="15" class="text-center text-muted py-4">
                                没有找到基础属性数据
                            </td>
                        </tr>
                    }
                    @foreach (var stat in Model.BaseStats)
                    {
                        <tr>
                            <td>
                                @switch (stat.Class)
                                {
                                    case "Warrior":
                                        <span class="badge bg-danger">战士</span>
                                        break;
                                    case "Wizard":
                                        <span class="badge bg-primary">法师</span>
                                        break;
                                    case "Taoist":
                                        <span class="badge bg-success">道士</span>
                                        break;
                                    case "Assassin":
                                        <span class="badge bg-dark">刺客</span>
                                        break;
                                }
                            </td>
                            <td>@stat.Level</td>
                            <td class="text-danger">@stat.Health</td>
                            <td class="text-primary">@stat.Mana</td>
                            <td>@stat.BagWeight</td>
                            <td>@stat.WearWeight</td>
                            <td>@stat.HandWeight</td>
                            <td>@stat.Accuracy</td>
                            <td>@stat.Agility</td>
                            <td>@stat.MinAC-@stat.MaxAC</td>
                            <td>@stat.MinMR-@stat.MaxMR</td>
                            <td>@stat.MinDC-@stat.MaxDC</td>
                            <td>@stat.MinMC-@stat.MaxMC</td>
                            <td>@stat.MinSC-@stat.MaxSC</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary edit-stat-btn"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editStatModal"
                                        data-class="@stat.Class"
                                        data-level="@stat.Level"
                                        data-health="@stat.Health"
                                        data-mana="@stat.Mana"
                                        data-bagweight="@stat.BagWeight"
                                        data-wearweight="@stat.WearWeight"
                                        data-handweight="@stat.HandWeight"
                                        data-accuracy="@stat.Accuracy"
                                        data-agility="@stat.Agility"
                                        data-minac="@stat.MinAC"
                                        data-maxac="@stat.MaxAC"
                                        data-minmr="@stat.MinMR"
                                        data-maxmr="@stat.MaxMR"
                                        data-mindc="@stat.MinDC"
                                        data-maxdc="@stat.MaxDC"
                                        data-minmc="@stat.MinMC"
                                        data-maxmc="@stat.MaxMC"
                                        data-minsc="@stat.MinSC"
                                        data-maxsc="@stat.MaxSC">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 离线角色转职 Modal -->
<div class="modal fade" id="changeClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" asp-page-handler="ChangeOfflineClass" onsubmit="return confirm('确定要修改该角色的职业吗？这将清空角色的所有技能！')">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-arrow-repeat"></i> 离线角色转职</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="characterIndex" id="modal-index">
                    <p>角色：<strong id="modal-name"></strong></p>
                    <p>当前职业：<span id="modal-class"></span></p>
                    <div class="mb-3">
                        <label class="form-label">新职业</label>
                        <select class="form-select" name="newClass" required>
                            <option value="">选择职业</option>
                            <option value="Warrior">战士</option>
                            <option value="Wizard">法师</option>
                            <option value="Taoist">道士</option>
                            <option value="Assassin">刺客</option>
                        </select>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i> 转职将清空角色所有技能！
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-arrow-repeat"></i> 确认转职
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑基础属性 Modal -->
<div class="modal fade" id="editStatModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" asp-page-handler="UpdateBaseStat">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-pencil-square"></i> 编辑基础属性</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="statClass" id="stat-class">
                    <input type="hidden" name="level" id="stat-level">
                    <p class="mb-3">职业：<strong id="stat-class-display"></strong> | 等级：<strong id="stat-level-display"></strong></p>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">生命值</label>
                            <input type="number" class="form-control" name="health" id="stat-health" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">魔法值</label>
                            <input type="number" class="form-control" name="mana" id="stat-mana" min="0" max="9999999">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">负重</label>
                            <input type="number" class="form-control" name="bagWeight" id="stat-bagweight" min="0" max="9999999">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">穿戴</label>
                            <input type="number" class="form-control" name="wearWeight" id="stat-wearweight" min="0" max="9999999">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">腕力</label>
                            <input type="number" class="form-control" name="handWeight" id="stat-handweight" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">准确</label>
                            <input type="number" class="form-control" name="accuracy" id="stat-accuracy" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">敏捷</label>
                            <input type="number" class="form-control" name="agility" id="stat-agility" min="0" max="9999999">
                        </div>
                        <div class="col-md-6"></div>
                        <div class="col-md-3">
                            <label class="form-label">最小AC</label>
                            <input type="number" class="form-control" name="minAC" id="stat-minac" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大AC</label>
                            <input type="number" class="form-control" name="maxAC" id="stat-maxac" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小MR</label>
                            <input type="number" class="form-control" name="minMR" id="stat-minmr" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大MR</label>
                            <input type="number" class="form-control" name="maxMR" id="stat-maxmr" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小DC</label>
                            <input type="number" class="form-control" name="minDC" id="stat-mindc" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大DC</label>
                            <input type="number" class="form-control" name="maxDC" id="stat-maxdc" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小MC</label>
                            <input type="number" class="form-control" name="minMC" id="stat-minmc" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大MC</label>
                            <input type="number" class="form-control" name="maxMC" id="stat-maxmc" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最小SC</label>
                            <input type="number" class="form-control" name="minSC" id="stat-minsc" min="0" max="9999999">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">最大SC</label>
                            <input type="number" class="form-control" name="maxSC" id="stat-maxsc" min="0" max="9999999">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-lg"></i> 保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // AJAX表单绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 职业开关按钮 - AJAX提交
            const toggleForms = document.querySelectorAll('form[asp-page-handler="ToggleClass"]');
            toggleForms.forEach(function(form) {
                AjaxForm.bindOne(form, {
                    successMessage: '职业创建设置已更新',
                    onSuccess: function(result) {
                        setTimeout(() => window.location.reload(), 800);
                    }
                });
            });

            // 在线玩家转职表单 - AJAX提交
            const changeClassForm = document.querySelector('form[asp-page-handler="ChangeClass"]');
            if (changeClassForm) {
                changeClassForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('确定要修改该玩家的职业吗？这将清空玩家的所有技能！')) {
                        AjaxForm.submit(changeClassForm, {
                            successMessage: '玩家转职成功',
                            resetForm: true
                        });
                    }
                });
            }

            // 离线角色转职模态框表单 - AJAX提交
            const offlineChangeForm = document.querySelector('form[asp-page-handler="ChangeOfflineClass"]');
            if (offlineChangeForm) {
                offlineChangeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    if (confirm('确定要修改该角色的职业吗？这将清空角色的所有技能！')) {
                        AjaxForm.submit(offlineChangeForm, {
                            successMessage: '角色转职成功',
                            closeModal: true,
                            modalId: 'changeClassModal',
                            onSuccess: function(result) {
                                setTimeout(() => window.location.reload(), 1000);
                            }
                        });
                    }
                });
            }

            // 新增基础属性表单 - AJAX提交
            const createStatForm = document.querySelector('form[asp-page-handler="CreateBaseStat"]');
            if (createStatForm) {
                AjaxForm.bindOne(createStatForm, {
                    successMessage: '基础属性已新增',
                    resetForm: true,
                    onSuccess: function(result) {
                        setTimeout(() => window.location.reload(), 1000);
                    }
                });
            }

            // 编辑基础属性模态框表单 - AJAX提交
            const updateStatForm = document.querySelector('form[asp-page-handler="UpdateBaseStat"]');
            if (updateStatForm) {
                AjaxForm.bindOne(updateStatForm, {
                    successMessage: '基础属性已保存',
                    closeModal: true,
                    modalId: 'editStatModal',
                    onSuccess: function(result) {
                        setTimeout(() => window.location.reload(), 1000);
                    }
                });
            }
        });

        // 转职 Modal
        var changeClassModal = document.getElementById('changeClassModal');
        changeClassModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            document.getElementById('modal-index').value = button.getAttribute('data-index');
            document.getElementById('modal-name').textContent = button.getAttribute('data-name');

            var classValue = button.getAttribute('data-class');
            var classMap = {
                'Warrior': '战士',
                'Wizard': '法师',
                'Taoist': '道士',
                'Assassin': '刺客'
            };
            document.getElementById('modal-class').textContent = classMap[classValue] || classValue;
        });

        // 编辑基础属性 Modal
        var editStatModal = document.getElementById('editStatModal');
        editStatModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var classValue = button.getAttribute('data-class');
            var classMap = {
                'Warrior': '战士',
                'Wizard': '法师',
                'Taoist': '道士',
                'Assassin': '刺客'
            };

            document.getElementById('stat-class').value = classValue;
            document.getElementById('stat-level').value = button.getAttribute('data-level');
            document.getElementById('stat-class-display').textContent = classMap[classValue] || classValue;
            document.getElementById('stat-level-display').textContent = button.getAttribute('data-level');

            document.getElementById('stat-health').value = button.getAttribute('data-health');
            document.getElementById('stat-mana').value = button.getAttribute('data-mana');
            document.getElementById('stat-bagweight').value = button.getAttribute('data-bagweight');
            document.getElementById('stat-wearweight').value = button.getAttribute('data-wearweight');
            document.getElementById('stat-handweight').value = button.getAttribute('data-handweight');
            document.getElementById('stat-accuracy').value = button.getAttribute('data-accuracy');
            document.getElementById('stat-agility').value = button.getAttribute('data-agility');
            document.getElementById('stat-minac').value = button.getAttribute('data-minac');
            document.getElementById('stat-maxac').value = button.getAttribute('data-maxac');
            document.getElementById('stat-minmr').value = button.getAttribute('data-minmr');
            document.getElementById('stat-maxmr').value = button.getAttribute('data-maxmr');
            document.getElementById('stat-mindc').value = button.getAttribute('data-mindc');
            document.getElementById('stat-maxdc').value = button.getAttribute('data-maxdc');
            document.getElementById('stat-minmc').value = button.getAttribute('data-minmc');
            document.getElementById('stat-maxmc').value = button.getAttribute('data-maxmc');
            document.getElementById('stat-minsc').value = button.getAttribute('data-minsc');
            document.getElementById('stat-maxsc').value = button.getAttribute('data-maxsc');
        });
    </script>
}
